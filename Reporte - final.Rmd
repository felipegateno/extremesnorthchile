---
title: "`r htmltools::HTML('<center><h1>Reporte de precipitaci√≥n<center></h1>')`"
author: "`r htmltools::HTML('<center><h4>Amphos21 Chile<center></h4>')`"
lang: "esp"
output:
  html_document:
    toc: true
    # theme: united
---
<style>
body {
text-align: justify}
</style>
```{css, echo=FALSE}
.rchunks_in {
  background-color: white;
  border: 0.5px solid black;
  font-weight: bold;
}
```
```{css, echo=FALSE}
.rchunks_out {
  background-color: white;
  border: 0.5px dashed black;
  font-weight: bold;
}
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment = "",
                      message = F,
                      warning = F,
                      fig.align = "center",
                      class.source = "rchunks_in",
                      class.output = "rchunks_out",
                      fig.width = 12,
                      fig.height = 7)
```

```{r, include=FALSE}
suppressPackageStartupMessages({
  library(openxlsx)
  library(dplyr)
  library(lubridate)
  library(tidyr)
  library(zoo)
  library(ggplot2)
  library(patchwork)
  library(knitr)
})
```

```{r, include=FALSE}
nombre_archivo <- "data/RegistrosDiarios_pr_2026-01-05.xlsx"
nombre_estacion <- "COPIAPO"

probs_exc <- c(0.05, 0.10, 0.20, 0.50, 0.85)

get_info_estacion <- function(nombre_archivo, nombre_estacion) {
  
  dt_estaciones <- read.xlsx(
    nombre_archivo,
    sheet = 1,
    detectDates = TRUE
  )
  
  info_estacion <- dt_estaciones %>%
    filter(name == nombre_estacion)
  
  if (nrow(info_estacion) == 0) {
    stop("La estaci√≥n no existe en el archivo.")
  }
  
  return(info_estacion)
}

# Ejecutar
info_estacion <- get_info_estacion(nombre_archivo, nombre_estacion)


```



# 1. Descripci√≥n de la estaci√≥n

La estaci√≥n pluviom√©trica **`r nombre_estacion`**, administrada por **`r info_estacion$owner`**, se localiza en la Regi√≥n **`r info_estacion$nombre_region`**, a una latitud de **`r round(info_estacion$lat,2)`¬∞**, longitud **`r round(info_estacion$lon,2)`¬∞** y una elevaci√≥n aproximada de **`r info_estacion$elev` m s.n.m.**. La estaci√≥n registra **precipitaci√≥n diaria (mm/d√≠a)** y cuenta con una serie de datos que se extiende desde **`r info_estacion$first_record`** hasta **`r info_estacion$last_record`**, totalizando **`r as.character(info_estacion$total_days)` d√≠as** de observaci√≥n.  De estos, **`r as.character(info_estacion$records_days)` d√≠as** presentan registros v√°lidos, lo que corresponde a una cobertura de **`r round(info_estacion$records_pctg,2)`%**, sin detecci√≥n de valores at√≠picos.


# 2. Descripci√≥n metodol√≥gica de las m√©tricas de precipitaci√≥n

## 2.1 M√©tricas Anuales

La caracterizaci√≥n de la variabilidad, intensidad y extremos de la precipitaci√≥n se realiz√≥ a partir de la serie diaria de precipitaci√≥n, calculando m√©tricas anuales por a√±o hidrol√≥gico (abril‚Äìmarzo). Las m√©tricas empleadas corresponden a √≠ndices ampliamente utilizados en climatolog√≠a e hidrolog√≠a, en particular aquellos propuestos por el Expert Team on Climate Change Detection and Indices (ETCCDI).

### Precipitaci√≥n total anual en d√≠as h√∫medos (PRCPTOT)

La m√©trica **PRCPTOT** corresponde a la suma anual de la precipitaci√≥n diaria registrada en d√≠as h√∫medos, definidos como aquellos con precipitaci√≥n estrictamente mayor a 0 mm. Este indicador permite cuantificar la cantidad total de agua precipitada en un a√±o hidrol√≥gico, excluyendo los d√≠as secos.

Matem√°ticamente, se define como:

$$
PRCPTOT_j = \sum_{i=1}^{N_j} RR_{ij}, \quad \text{con } RR_{ij} > 0
$$

donde $RR_{ij}$ es la precipitaci√≥n diaria del d√≠a $i$ en el a√±o hidrol√≥gico $j$, y $N_j$ corresponde al n√∫mero total de d√≠as del a√±o.

---

### √çndice de intensidad diaria simple (SDII)

El **SDII (Simple Daily Intensity Index)** representa la intensidad media de la precipitaci√≥n durante los d√≠as h√∫medos de un a√±o hidrol√≥gico. Se calcula como el cociente entre la precipitaci√≥n total anual en d√≠as h√∫medos y el n√∫mero de d√≠as h√∫medos del a√±o.

Se modifico para los a√±os con registro de precipitaci√≥n 0, para estos se les asigna un $SDII = 0$
$$
SDII_j = \frac{\sum RR_{ij}}{N_{wet,j}}, \quad \text{con } RR_{ij} > 0
$$

donde $N_{wet,j}$ es el n√∫mero de d√≠as h√∫medos del a√±o hidrol√≥gico $j$. Valores elevados de SDII indican una mayor concentraci√≥n de la precipitaci√≥n en eventos intensos.

---

### Precipitaci√≥n m√°xima en 1 d√≠a (Rx1day)

La m√©trica **Rx1day** corresponde al mayor monto de precipitaci√≥n diaria registrado dentro de un a√±o hidrol√≥gico y es un indicador directo de eventos extremos de corta duraci√≥n.

$$
Rx1day_j = \max(RR_{ij})
$$

---

### Precipitaci√≥n m√°xima en 5 d√≠as consecutivos (Rx5day)

La m√©trica **Rx5day** representa el m√°ximo acumulado de precipitaci√≥n en cualquier per√≠odo m√≥vil de cinco d√≠as consecutivos dentro de un a√±o hidrol√≥gico. Para su c√°lculo se utiliza una suma m√≥vil de cinco d√≠as.

$$
Rx5day_j = \max \left( \sum_{k=i}^{i+4} RR_{kj} \right)
$$

Este √≠ndice es relevante para evaluar eventos persistentes asociados a crecidas y saturaci√≥n del suelo.

---

### N√∫mero de d√≠as con precipitaci√≥n mayor o igual a 10 mm (R10mm)

El √≠ndice **R10mm** corresponde al n√∫mero de d√≠as en un a√±o hidrol√≥gico en los que la precipitaci√≥n diaria es igual o superior a 10 mm, y permite evaluar la frecuencia de eventos de precipitaci√≥n moderada a intensa.

$$
R10mm_j = \sum_{i=1}^{N_j} I(RR_{ij} \ge 10)
$$

donde $I(\cdot)$ es una funci√≥n indicadora que toma valor 1 cuando la condici√≥n se cumple y 0 en caso contrario.

---

### N√∫mero de d√≠as con precipitaci√≥n mayor o igual a 20 mm (R20mm)

El √≠ndice **R20mm** contabiliza el n√∫mero de d√≠as por a√±o hidrol√≥gico con precipitaci√≥n diaria igual o superior a 20 mm, asociado a eventos intensos.

$$
R20mm_j = \sum_{i=1}^{N_j} I(RR_{ij} \ge 20)
$$

---

### M√°xima racha de d√≠as secos consecutivos (CDD)

La m√©trica **CDD (Consecutive Dry Days)** corresponde al mayor n√∫mero de d√≠as secos consecutivos dentro de un a√±o hidrol√≥gico, considerando como d√≠a seco aquel con precipitaci√≥n igual a 0 mm.

$$
CDD_j = \max(L_{dry})
$$

donde $L_{dry}$ representa la longitud de cada racha consecutiva de d√≠as con $RR_{ij} = 0$.

---

### M√°xima racha de d√≠as h√∫medos consecutivos (CWD)

La m√©trica **CWD (Consecutive Wet Days)** corresponde al mayor n√∫mero de d√≠as h√∫medos consecutivos dentro de un a√±o hidrol√≥gico, definiendo como d√≠a h√∫medo aquel con precipitaci√≥n mayor a 0 mm.

$$
CWD_j = \max(L_{wet})
$$

donde $L_{wet}$ representa la longitud de cada racha consecutiva de d√≠as con $RR_{ij} > 0$.

---

### Precipitaci√≥n anual sobre el percentil 95 (R95pTOT)

La m√©trica **R95pTOT** corresponde a la suma anual de la precipitaci√≥n diaria asociada a eventos extremos moderados, definidos como aquellos d√≠as cuya precipitaci√≥n supera el percentil 95 ($P_{95}$) de la distribuci√≥n de precipitaci√≥n diaria positiva del per√≠odo de referencia.

$$
R95pTOT_j = \sum RR_{ij}, \quad \text{con } RR_{ij} > P_{95}
$$

---

### Precipitaci√≥n anual sobre el percentil 99 (R99pTOT)

La m√©trica **R99pTOT** representa la suma anual de la precipitaci√≥n diaria correspondiente a eventos extremos severos, definidos como aquellos d√≠as con precipitaci√≥n superior al percentil 99 ($P_{99}$) de la distribuci√≥n de precipitaci√≥n diaria positiva del per√≠odo de referencia.

$$
R99pTOT_j = \sum RR_{ij}, \quad \text{con } RR_{ij} > P_{99}
$$

## 2.2 Metricas Mensuales 
### Curva de Variaci√≥n Estacional (CVE)

La **Curva de Variaci√≥n Estacional (CVE)** representa la distribuci√≥n intra‚Äìanual de la **precipitaci√≥n mensual acumulada** a lo largo del a√±o hidrol√≥gico, permitiendo identificar el r√©gimen estacional de las lluvias y los per√≠odos h√∫medos y secos predominantes.

Sea $RR_{i,j}$ la precipitaci√≥n mensual acumulada del mes $i$ en el a√±o hidrol√≥gico $j$, con $i = 1, \dots, 12$. La precipitaci√≥n media mensual acumulada se define como:

$$
\overline{RR}_i = \frac{1}{N} \sum_{j=1}^{N} RR_{i,j}
$$

donde $N$ es el n√∫mero de a√±os hidrol√≥gicos con informaci√≥n v√°lida.

La CVE se obtiene graficando $\overline{RR}_i$ en funci√≥n del mes hidrol√≥gico, ordenado desde abril hasta marzo. Esta curva permite:

- Identificar la concentraci√≥n temporal de la precipitaci√≥n.
- Reconocer el mes o per√≠odo de mayor aporte pluviom√©trico.
- Comparar el comportamiento estacional entre estaciones o cuencas.

---

###  Estad√≠sticos Mensuales de la Precipitaci√≥n (Media, Desviaci√≥n Est√°ndar y Coeficiente de Variaci√≥n)

Con el objetivo de caracterizar la variabilidad interanual de la precipitaci√≥n mensual, se calculan los principales estad√≠sticos descriptivos para cada mes hidrol√≥gico.

La **media mensual** se define como:

$$
\overline{RR}_i = \frac{1}{N} \sum_{j=1}^{N} RR_{i,j}
$$

La **desviaci√≥n est√°ndar mensual**, que cuantifica la dispersi√≥n de los valores respecto a la media, se calcula como:

$$
\sigma_i = \sqrt{\frac{1}{N-1} \sum_{j=1}^{N} \left(RR_{i,j} - \overline{RR}_i\right)^2}
$$

Finalmente, el **coeficiente de variaci√≥n (CV)**, utilizado como una medida adimensional de la variabilidad relativa, se define como:

$$
CV_i = \frac{\sigma_i}{\overline{RR}_i}
$$

Valores elevados de $CV_i$ indican una alta variabilidad interanual de la precipitaci√≥n mensual, caracter√≠stica com√∫n en climas √°ridos y semi√°ridos.

---

###  √çndice de Estacionalidad de la Precipitaci√≥n (√çndice de Markham)

El **√çndice de Estacionalidad de Markham (SI)** cuantifica el grado de concentraci√≥n temporal de la precipitaci√≥n anual y permite, adicionalmente, identificar el momento del a√±o en que dicha precipitaci√≥n se concentra. A diferencia de otros √≠ndices de estacionalidad, este m√©todo representa la precipitaci√≥n mensual como vectores angulares distribuidos uniformemente a lo largo del ciclo anual.

Sea $P_m$ la precipitaci√≥n total del mes $m$ en un a√±o hidrol√≥gico, con $m = 1, \dots, 12$, y sea $P_{anual}$ la precipitaci√≥n total anual, definida como:

$$
P_{anual} = \sum_{m=1}^{12} P_m
$$

A cada mes se le asigna un √°ngulo $\theta_m$ en el c√≠rculo anual, definido como:

$$
\theta_m = \frac{2\pi}{12}(m - 1)
$$

La precipitaci√≥n mensual se representa como un vector de magnitud $P_m$ y direcci√≥n $\theta_m$. Las componentes del vector resultante anual se calculan como:

$$
X = \sum_{m=1}^{12} P_m \cos(\theta_m)
$$

$$
Y = \sum_{m=1}^{12} P_m \sin(\theta_m)
$$

El **√çndice de Estacionalidad de Markham** se define como la magnitud del vector resultante normalizada por la precipitaci√≥n anual:

$$
SI = \frac{\sqrt{X^2 + Y^2}}{P_{anual}}
$$

Este √≠ndice es adimensional y toma valores comprendidos entre 0 y 1, donde valores cercanos a 0 indican una distribuci√≥n uniforme de la precipitaci√≥n a lo largo del a√±o, mientras que valores cercanos a 1 reflejan una fuerte concentraci√≥n de la precipitaci√≥n en un per√≠odo reducido del a√±o.

Adicionalmente, la **fase estacional** o mes dominante de la precipitaci√≥n se obtiene a partir del √°ngulo del vector resultante:

$$
\phi = \arctan\left(\frac{Y}{X}\right)
$$

La fase $\phi$ permite identificar el mes o estaci√≥n del a√±o en la cual se concentra el mayor aporte pluviom√©trico.

# 3.Resultados
```{r, echo = F}
# Directorio
get_data_estacion <- function(nombre_archivo, nombre_estacion) {
  
  # Leer datos
  dt <- read.xlsx(nombre_archivo, sheet = 2)
  dt_estaciones <- read.xlsx(nombre_archivo, sheet = 1)
  
  # Obtener ID estaci√≥n
  id_estacion <- dt_estaciones %>%
    filter(name == nombre_estacion) %>%
    pull(id)
  
  if (length(id_estacion) == 0) {
    stop("La estaci√≥n no existe en el archivo.")
  }
  
  # Construir serie diaria continua
  data_estacion <- dt %>%
    filter(id %in% id_estacion) %>%
    mutate(
      date = as.Date(date, origin = "1899-12-30")
    ) %>%
    rename(RR = value) %>%
    arrange(date) %>%
    complete(
      date = seq(min(date), max(date), by = "day"),
      fill = list(RR = NA_real_)
    ) %>%
    mutate(
      date_hidrologico = date %m-% months(3),
      year = year(date_hidrologico)
    ) %>% 
    select(-variable)
  
  return(data_estacion)
}

calcular_metricas_anuales <- function(data_estacion,
                                      year_min = 1966,
                                      year_max = 2025) {

  # ---------------------------
  # Tabla base de a√±os
  # ---------------------------
  years_tbl <- tibble(year = year_min:year_max)
  
  # ---------------------------
  # Conteo y calidad de datos
  # ---------------------------
  n_wet_dry <- data_estacion %>%
    mutate(
      year_start = as.Date(paste0(year - 1, "-04-01")),
      year_end   = as.Date(paste0(year, "-03-31")),
      n_days_year = as.integer(year_end - year_start + 1)
    ) %>%
    group_by(year) %>%
    summarise(
      n_days   = first(n_days_year),
      n_valid  = sum(!is.na(RR)),
      pct_valid = 100 * n_valid / n_days,
      n_wet = if (all(is.na(RR))) NA_integer_ else sum(RR > 0, na.rm = TRUE),
      n_dry = if (all(is.na(RR))) NA_integer_ else sum(RR == 0, na.rm = TRUE),
      .groups = "drop"
    )
  
  # ---------------------------
  # RxDdia
  # ---------------------------
  RxDdia <- function(D) {
    data_estacion %>%
      arrange(date) %>%
      mutate(RR_D = zoo::rollsum(RR, k = D, fill = NA, align = "center")) %>%
      group_by(year) %>%
      summarise(
        !!paste0("Rx", D, "day") :=
          if (all(is.na(RR))) NA_real_
        else max(RR_D, na.rm = TRUE),
        .groups = "drop"
      )
  }
  
  Rx1day <- RxDdia(1)
  Rx5day <- RxDdia(5)
  
  # ---------------------------
  # SDII
  # ---------------------------
  SDII <- data_estacion %>%
    group_by(year) %>%
    summarise(
      SDII = if (all(is.na(RR))) NA_real_
      else if (sum(RR > 0, na.rm = TRUE) == 0) 0
      else sum(RR[RR > 0], na.rm = TRUE) / sum(RR > 0, na.rm = TRUE),
      .groups = "drop"
    )
  
  # ---------------------------
  # Rnnmm
  # ---------------------------
  Rnnmm <- function(nn, name) {
    data_estacion %>%
      group_by(year) %>%
      summarise(
        !!name := if (all(is.na(RR))) NA_integer_
        else sum(RR >= nn, na.rm = TRUE),
        .groups = "drop"
      )
  }
  
  R10mm <- Rnnmm(10, "R10mm")
  R20mm <- Rnnmm(20, "R20mm")
  
  # ---------------------------
  # CDD / CWD
  # ---------------------------
  CD <- function(tipo) {
    data_estacion %>%
      arrange(date_hidrologico) %>%
      mutate(
        condicion = case_when(
          tipo == "seco"   & RR == 0 ~ TRUE,
          tipo == "humedo" & RR >  0 ~ TRUE,
          TRUE ~ FALSE
        )
      ) %>%
      group_by(year) %>%
      summarise(
        !!tipo := {
          if (all(is.na(RR))) NA_integer_
          else {
            r <- rle(condicion)
            if (any(r$values)) max(r$lengths[r$values]) else 0
          }
        },
        .groups = "drop"
      )
  }
  
  CDD <- CD("CDD")
  CWD <- CD("CWD")
  
  # ---------------------------
  # PRCPTOT
  # ---------------------------
  PRCPTOT <- data_estacion %>%
    group_by(year) %>%
    summarise(
      PRCPTOT = if (all(is.na(RR))) NA_real_
      else sum(RR[RR > 0], na.rm = TRUE),
      .groups = "drop"
    )
  
  # ---------------------------
  # Percentiles
  # ---------------------------
  ref <- data_estacion %>%
    filter(year >= year_min, year <= year_max, RR > 0)
  
  p95 <- quantile(ref$RR, 0.95, na.rm = TRUE, type = 6)
  p99 <- quantile(ref$RR, 0.99, na.rm = TRUE, type = 6)
  
  Rper <- function(p, name) {
    data_estacion %>%
      group_by(year) %>%
      summarise(
        !!name := if (all(is.na(RR))) NA_real_
        else sum(RR[RR > p], na.rm = TRUE),
        .groups = "drop"
      )
  }
  
  R95pTOT <- Rper(p95, "R95pTOT")
  R99pTOT <- Rper(p99, "R99pTOT")
  
  # ---------------------------
  # MATRIZ FINAL
  # ---------------------------
  metricas <- years_tbl %>%
    left_join(n_wet_dry, by = "year") %>%
    left_join(Rx1day, by = "year") %>%
    left_join(Rx5day, by = "year") %>%
    left_join(SDII, by = "year") %>%
    left_join(R10mm, by = "year") %>%
    left_join(R20mm, by = "year") %>%
    left_join(CDD, by = "year") %>%
    left_join(CWD, by = "year") %>%
    left_join(PRCPTOT, by = "year") %>%
    left_join(R95pTOT, by = "year") %>%
    left_join(R99pTOT, by = "year")
  
  return(metricas)
}

data_estacion <- get_data_estacion(
  nombre_archivo ,
  nombre_estacion
)

metricas_data <- calcular_metricas_anuales(data_estacion)


#graficos

theme_metrica <- theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11, colour = "grey30"),
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    panel.grid.minor = element_blank(),
    legend.position = "none"
  )

plot_metrica_ts <- function(data, var, subtitulo, ylab) {
  ggplot(
    data,
    aes(x = year, y = .data[[var]])
  ) +
    geom_line(linewidth = 0.9) +
    geom_point(size = 2) +
    labs(
      title = nombre_estacion,
      subtitle = subtitulo,
      x = "A√±o hidrol√≥gico",
      y = ylab
    ) +
    theme_metrica
}

p_PRCPTOT <- plot_metrica_ts(
  metricas_data,
  "PRCPTOT",
  "Precipitaci√≥n total anual en d√≠as h√∫medos",
  "PRCPTOT (mm/a√±o)"
)

p_SDII <- plot_metrica_ts(
  metricas_data,
  "SDII",
  "√çndice de intensidad diaria",
  "SDII (mm/d√≠a h√∫medo)"
)

p_R95 <- plot_metrica_ts(
  metricas_data,
  "R95pTOT",
  "Precipitaci√≥n anual sobre el percentil 95",
  "R95pTOT (mm)"
)

p_R99 <- plot_metrica_ts(
  metricas_data,
  "R99pTOT",
  "Precipitaci√≥n anual sobre el percentil 99",
  "R99pTOT (mm)"
)


(p_PRCPTOT / p_SDII / p_R95) +
  plot_annotation(
    title = nombre_estacion,
    subtitle = "Evoluci√≥n temporal de cantidad, intensidad y extremos de precipitaci√≥n"
  )

ggplot(
  metricas_data,
  aes(R95pTOT, R99pTOT)
) +
  geom_point(alpha = 0.7, na.rm = TRUE) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  coord_equal() +
  theme_metrica +
  labs(
    title = nombre_estacion,
    subtitle = "Comparaci√≥n entre extremos moderados y severos",
    x = "R95pTOT (mm)",
    y = "R99pTOT (mm)"
  )

labels_metricas <- c(
  PRCPTOT = "PRCPTOT (mm/a√±o)",
  SDII    = "SDII (mm/d√≠a)",
  Rx1day  = "Rx1d√≠a (mm)",
  Rx5day  = "Rx5d√≠a (mm)",
  R95pTOT = "R95pTOT (mm)",
  R99pTOT = "R99pTOT (mm)"
)


metricas_data_long <- metricas_data %>%
  select(PRCPTOT, SDII, Rx1day, Rx5day, R95pTOT, R99pTOT) %>%
  pivot_longer(everything(), names_to = "metrica", values_to = "valor")

ggplot(
  metricas_data_long,
  aes(metrica, valor)
) +
  geom_boxplot(outlier.shape = NA, fill = "grey85") +
  geom_jitter(width = 0.15, alpha = 0.5, size = 1) +
  coord_flip() +
  scale_x_discrete(labels = labels_metricas) +
  theme_metrica +
  labs(
    title = nombre_estacion,
    subtitle = "Distribuci√≥n interanual de m√©tricas de precipitaci√≥n",
    x = NULL,
    y = "Valor"
  )



plot_comp <- function(data, x, y, xlab, ylab, subtitulo = NULL) {
  ggplot(data, aes({{x}}, {{y}})) +
    geom_point(alpha = 0.7, na.rm = TRUE) +
    geom_smooth(method = "lm", se = FALSE, linewidth = 0.8) +
    theme_metrica +
    labs(
      title = nombre_estacion,
      subtitle = subtitulo,
      x = xlab,
      y = ylab
    )
}


p_line <- plot_metrica_ts(
  metricas_data,
  "PRCPTOT",
  "Cantidad anual de precipitaci√≥n",
  "PRCPTOT (mm/a√±o)"
)

p_scatter <- plot_comp(
  metricas_data,
  PRCPTOT, SDII,
  "PRCPTOT (mm/a√±o)",
  "SDII (mm/d√≠a)",
  "Cantidad vs intensidad"
)

p_box <- ggplot(metricas_data, aes(x = "", y = Rx5day)) +
  geom_boxplot(fill = "grey85") +
  geom_jitter(width = 0.08, alpha = 0.6) +
  theme_metrica +
  labs(
    title = nombre_estacion,
    subtitle = "Variabilidad interanual de extremos",
    x = NULL,
    y = "Rx5d√≠a (mm)"
  )

(p_line | p_scatter | p_box) +
  plot_annotation(
    title = nombre_estacion,
    subtitle = "Cantidad, intensidad y extremos de la precipitaci√≥n"
  )

p_Rnn <- ggplot(metricas_data, aes(x = year)) +
  
  geom_line(
    aes(y = R10mm, color = "R10mm"),
    linewidth = 1
  ) +
  geom_point(
    aes(y = R10mm, color = "R10mm"),
    size = 2
  ) +
  
  geom_line(
    aes(y = R20mm, color = "R20mm"),
    linewidth = 1
  ) +
  geom_point(
    aes(y = R20mm, color = "R20mm"),
    size = 2
  ) +
  
  scale_color_manual(
    name = "M√©trica",
    values = c(
      "R10mm" = "#1f78b4",
      "R20mm" = "#b2182b"
    ),
    labels = c(
      "R10mm" = "D√≠as con precipitaci√≥n ‚â• 10 mm",
      "R20mm" = "D√≠as con precipitaci√≥n ‚â• 20 mm"
    )
  ) +
  
  labs(
    title = nombre_estacion,
    subtitle = "Frecuencia anual de eventos de precipitaci√≥n moderada y severa",
    x = "A√±o hidrol√≥gico",
    y = "N√∫mero de d√≠as (d√≠as/a√±o)"
  ) +
  
  theme_metrica +
  theme(
    legend.position = "bottom"
  )

# üëá ESTA L√çNEA ES LA CLAVE
p_Rnn


 #Metricas Mensuales
 
 
# =========================================================
# 1. DATOS DIARIOS
# =========================================================
get_data_daily <- function(nombre_archivo, nombre_estacion) {
  
  dt  <- read.xlsx(nombre_archivo, sheet = 2, detectDates = TRUE)
  est <- read.xlsx(nombre_archivo, sheet = 1)
  
  id_est <- est %>%
    filter(name == nombre_estacion) %>%
    pull(id)
  
  if (length(id_est) == 0) stop("Estaci√≥n no encontrada.")
  
  dt %>%
    filter(id == id_est) %>%
    mutate(
      date = as.Date(date, origin = "1899-12-30"),
      RR   = value
    ) %>%
    select(date, RR)
}

# =========================================================
# 2. MATRIZ MENSUAL (A√ëO HIDROL√ìGICO)
# =========================================================
get_monthly_matrix <- function(data_daily, umbral_cobertura = 0.8) {
  
  meses <- c("Abr","May","Jun","Jul","Ago","Sep",
             "Oct","Nov","Dic","Ene","Feb","Mar")
  
  data_daily %>%
    mutate(
      date_h  = date %m-% months(3),
      year_h  = year(date_h),
      month_h = month(date_h)
    ) %>%
    group_by(year_h, month_h) %>%
    summarise(
      RR_sum = sum(RR, na.rm = TRUE),
      dias   = n(),
      validos = sum(!is.na(RR)),
      cobertura = validos / dias,
      RR_month = ifelse(cobertura >= umbral_cobertura, RR_sum, NA_real_),
      .groups = "drop"
    ) %>%
    mutate(Mes = factor(month_h, levels = 1:12, labels = meses)) %>%
    select(year_h, Mes, RR_month) %>%
    pivot_wider(names_from = Mes, values_from = RR_month) %>%
    arrange(year_h)
}

# =========================================================
# MATRIZ MENSUAL DE EXCEDENCIA (WEIBULL POR A√ëO)
# =========================================================
build_matriz_pexcc <- function(matriz_mensual) {
  
  meses <- setdiff(names(matriz_mensual), "year_h")
  N     <- nrow(matriz_mensual)
  
  Pexc <- (1:N) / (N + 1)
  
  matriz_pexcc <- data.frame(Pexc = Pexc)
  
  for (mes in meses) {
    
    x <- matriz_mensual[[mes]]
    ord <- order(x, decreasing = TRUE, na.last = NA)
    
    col <- rep(NA_real_, N)
    col[seq_along(ord)] <- x[ord]
    
    matriz_pexcc[[mes]] <- col
  }
  
  matriz_pexcc
}
# =========================================================
# 4. CURVAS DE EXCEDENCIA
# =========================================================
calc_curvas_pexcc <- function(matriz_pexcc, probs_exc) {
  
  meses <- setdiff(names(matriz_pexcc), "Pexc")
  
  curvas <- lapply(meses, function(mes) {
    
    df <- matriz_pexcc %>%
      select(Pexc, RR = all_of(mes)) %>%
      filter(!is.na(RR)) %>%
      arrange(Pexc)
    
    if (nrow(df) < 2) {
      return(rep(NA_real_, length(probs_exc)))
    }
    
    approx(
      x    = df$Pexc,
      y    = df$RR,
      xout = probs_exc,
      rule = 1   # NO extrapola
    )$y
  })
  
  curvas_df <- as.data.frame(curvas)
  colnames(curvas_df) <- meses
  
  curvas_df %>%
    mutate(Pexc = probs_exc) %>%
    relocate(Pexc)
}

# =========================================================
# 5. EJECUCI√ìN
# =========================================================
data_daily     <- get_data_daily(nombre_archivo, nombre_estacion)
matriz_mensual <- get_monthly_matrix(data_daily)
matriz_pexcc   <- build_matriz_pexcc(matriz_mensual)
curvas_pexcc   <- calc_curvas_pexcc(matriz_pexcc, probs_exc)
```
```{r, echo = F}
# =========================================================
# 6. GR√ÅFICO
# =========================================================
meses_hidro <- c("Abr","May","Jun","Jul","Ago","Sep",
                 "Oct","Nov","Dic","Ene","Feb","Mar")

curvas_long <- curvas_pexcc %>%
  pivot_longer(cols = -Pexc, names_to = "Mes", values_to = "RR") %>%
  mutate(
    Mes = factor(Mes, levels = meses_hidro),
    Pexc_lab = paste0("P", Pexc * 100, "%")
  )

ggplot(curvas_long,
       aes(Mes, RR, color = Pexc_lab, group = Pexc_lab)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  labs(
    title = paste("Curvas mensuales de excedencia ‚Äì", nombre_estacion),
    x = "Mes hidrol√≥gico",
    y = "Precipitaci√≥n mensual (mm)",
    color = "Prob. excedencia"
  ) +
  theme_minimal()


# =========================================================
# 8. √çNDICE DE ESTACIONALIDAD DE MARKHAM
# =========================================================
calc_SI_Markham <- function(matriz_mensual) {
  
  meses <- setdiff(names(matriz_mensual), "year_h")
  n_mes <- length(meses)
  
  # √Ångulos hidrol√≥gicos (Abr = 0, Mar = 330¬∞)
  theta <- 2 * pi / n_mes * (0:(n_mes - 1))
  
  matriz_mensual %>%
    rowwise() %>%
    mutate(
      P_anual = sum(c_across(all_of(meses)), na.rm = TRUE),
      
      X = ifelse(
        P_anual == 0,
        NA_real_,
        sum(c_across(all_of(meses)) * cos(theta), na.rm = TRUE)
      ),
      
      Y = ifelse(
        P_anual == 0,
        NA_real_,
        sum(c_across(all_of(meses)) * sin(theta), na.rm = TRUE)
      ),
      
      SI_Markham = ifelse(
        P_anual == 0,
        NA_real_,
        sqrt(X^2 + Y^2) / P_anual
      ),
      
      Fase_rad = atan2(Y, X),
      
      Fase_mes = ifelse(
        is.na(Fase_rad),
        NA_real_,
        ((Fase_rad %% (2 * pi)) / (2 * pi)) * n_mes + 1
      )
    ) %>%
    ungroup() %>%
    select(year_h, P_anual, SI_Markham, Fase_mes)
}

SI_Markham_df <- calc_SI_Markham(matriz_mensual)

ggplot(SI_Markham_df, aes(x = year_h)) +
  
  # L√≠nea SI Markham
  geom_line(
    aes(y = SI_Markham, color = "SI de Markham"),
    linewidth = 1
  ) +
  
  # Puntos SI Markham
  geom_point(
    aes(y = SI_Markham, color = "SI de Markham"),
    size = 2
  ) +
  
  # Puntos fase (escalada a [0,1])
  geom_point(
    aes(y = Fase_mes / 12, color = "Mes dominante"),
    size = 2
  ) +
  
  scale_color_manual(
    name = "Variable",
    values = c(
      "SI de Markham" = "steelblue",
      "Mes dominante" = "firebrick"
    )
  ) +
  
  scale_y_continuous(
    name = "SI de Markham",
    sec.axis = sec_axis(
      ~ . * 12,
      name = "Mes dominante",
      breaks = 1:12,
      labels = c("Abr","May","Jun","Jul","Ago","Sep",
                 "Oct","Nov","Dic","Ene","Feb","Mar")
    )
  ) +
  
  labs(
    title = "Estacionalidad y fase dominante de la precipitaci√≥n",
    x = "A√±o hidrol√≥gico"
  ) +
  
  theme_minimal() +
  theme(
    legend.position = "bottom"
  )


# =========================================================
# M√âTRICAS ESTAD√çSTICAS MENSUALES (MEDIA, SD, CV)
# =========================================================
calc_stats_mensuales <- function(matriz_mensual) {
  
  meses <- setdiff(names(matriz_mensual), "year_h")
  
  matriz_mensual %>%
    pivot_longer(
      cols = all_of(meses),
      names_to = "Mes",
      values_to = "RR"
    ) %>%
    group_by(Mes) %>%
    summarise(
      Media = mean(RR, na.rm = TRUE),
      SD    = sd(RR, na.rm = TRUE),
      CV    = ifelse(Media == 0 | is.na(Media),
                     NA_real_,
                     SD / Media),
      .groups = "drop"
    ) %>%
    mutate(
      Mes = factor(
        Mes,
        levels = c("Abr","May","Jun","Jul","Ago","Sep",
                   "Oct","Nov","Dic","Ene","Feb","Mar")
      )
    ) %>%
    arrange(Mes)
}

stats_mensuales <- calc_stats_mensuales(matriz_mensual)

ggplot(stats_mensuales,
       aes(x = Mes, y = Media)) +
  geom_col(fill = "steelblue") +
  geom_errorbar(
    aes(ymin = Media - SD, ymax = Media + SD),
    width = 0.2
  ) +
  labs(
    title = "Climatolog√≠a mensual de precipitaci√≥n",
    x = "Mes hidrol√≥gico",
    y = "Precipitaci√≥n mensual media (mm)"
  ) +
  theme_minimal()
```


