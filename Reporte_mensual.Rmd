---
title: "`r htmltools::HTML('<center><h1>Reporte de precipitación mensual <center></h1>')`"
author: "`r htmltools::HTML('<center><h4>Amphos21 Chile<center></h4>')`"
lang: "esp"
output:
  html_document:
    toc: true
    # theme: united
---
<style>
body {
text-align: justify}
</style>
```{css, echo=FALSE}
.rchunks_in {
  background-color: white;
  border: 0.5px solid black;
  font-weight: bold;
}
```
```{css, echo=FALSE}
.rchunks_out {
  background-color: white;
  border: 0.5px dashed black;
  font-weight: bold;
}
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment = "",
                      message = F,
                      warning = F,
                      fig.align = "center",
                      class.source = "rchunks_in",
                      class.output = "rchunks_out",
                      fig.width = 12,
                      fig.height = 7)
```

```{r, include=FALSE}
suppressPackageStartupMessages({
  library(openxlsx)
  library(dplyr)
  library(lubridate)
  library(tidyr)
  library(zoo)
  library(ggplot2)
  library(patchwork)
  library(knitr)
})
```
```{r, include=FALSE}
nombre_archivo <- "data/RegistrosDiarios_pr_2026-01-05.xlsx"
nombre_estacion <- "COPIAPO"

get_info_estacion <- function(nombre_archivo, nombre_estacion) {
  
  dt_estaciones <- read.xlsx(
    nombre_archivo,
    sheet = 1,
    detectDates = TRUE
  )
  
  info_estacion <- dt_estaciones %>%
    filter(name == nombre_estacion)
  
  if (nrow(info_estacion) == 0) {
    stop("La estación no existe en el archivo.")
  }
  
  return(info_estacion)
}

# Ejecutar
info_estacion <- get_info_estacion(nombre_archivo, nombre_estacion)


```
```{r, include=FALSE}
nombre_archivo  <- "data/RegistrosDiarios_pr_2026-01-05.xlsx"
nombre_estacion <- "COPIAPO"

probs_exc <- c(0.05, 0.10, 0.20, 0.50, 0.85)

# =========================================================
# 1. DATOS DIARIOS
# =========================================================
get_data_daily <- function(nombre_archivo, nombre_estacion) {
  
  dt  <- read.xlsx(nombre_archivo, sheet = 2, detectDates = TRUE)
  est <- read.xlsx(nombre_archivo, sheet = 1)
  
  id_est <- est %>%
    filter(name == nombre_estacion) %>%
    pull(id)
  
  if (length(id_est) == 0) stop("Estación no encontrada.")
  
  dt %>%
    filter(id == id_est) %>%
    mutate(
      date = as.Date(date, origin = "1899-12-30"),
      RR   = value
    ) %>%
    select(date, RR)
}

# =========================================================
# 2. MATRIZ MENSUAL (AÑO HIDROLÓGICO)
# =========================================================
get_monthly_matrix <- function(data_daily, umbral_cobertura = 0.8) {
  
  meses <- c("Abr","May","Jun","Jul","Ago","Sep",
             "Oct","Nov","Dic","Ene","Feb","Mar")
  
  data_daily %>%
    mutate(
      date_h  = date %m-% months(3),
      year_h  = year(date_h),
      month_h = month(date_h)
    ) %>%
    group_by(year_h, month_h) %>%
    summarise(
      RR_sum = sum(RR, na.rm = TRUE),
      dias   = n(),
      validos = sum(!is.na(RR)),
      cobertura = validos / dias,
      RR_month = ifelse(cobertura >= umbral_cobertura, RR_sum, NA_real_),
      .groups = "drop"
    ) %>%
    mutate(Mes = factor(month_h, levels = 1:12, labels = meses)) %>%
    select(year_h, Mes, RR_month) %>%
    pivot_wider(names_from = Mes, values_from = RR_month) %>%
    arrange(year_h)
}

# =========================================================
# MATRIZ MENSUAL DE EXCEDENCIA (WEIBULL POR AÑO)
# =========================================================
build_matriz_pexcc <- function(matriz_mensual) {
  
  meses <- setdiff(names(matriz_mensual), "year_h")
  N     <- nrow(matriz_mensual)
  
  Pexc <- (1:N) / (N + 1)
  
  matriz_pexcc <- data.frame(Pexc = Pexc)
  
  for (mes in meses) {
    
    x <- matriz_mensual[[mes]]
    ord <- order(x, decreasing = TRUE, na.last = NA)
    
    col <- rep(NA_real_, N)
    col[seq_along(ord)] <- x[ord]
    
    matriz_pexcc[[mes]] <- col
  }
  
  matriz_pexcc
}
# =========================================================
# 4. CURVAS DE EXCEDENCIA
# =========================================================
calc_curvas_pexcc <- function(matriz_pexcc, probs_exc) {
  
  meses <- setdiff(names(matriz_pexcc), "Pexc")
  
  curvas <- lapply(meses, function(mes) {
    
    df <- matriz_pexcc %>%
      select(Pexc, RR = all_of(mes)) %>%
      filter(!is.na(RR)) %>%
      arrange(Pexc)
    
    if (nrow(df) < 2) {
      return(rep(NA_real_, length(probs_exc)))
    }
    
    approx(
      x    = df$Pexc,
      y    = df$RR,
      xout = probs_exc,
      rule = 1   # NO extrapola
    )$y
  })
  
  curvas_df <- as.data.frame(curvas)
  colnames(curvas_df) <- meses
  
  curvas_df %>%
    mutate(Pexc = probs_exc) %>%
    relocate(Pexc)
}

# =========================================================
# 5. EJECUCIÓN
# =========================================================
data_daily     <- get_data_daily(nombre_archivo, nombre_estacion)
matriz_mensual <- get_monthly_matrix(data_daily)
matriz_pexcc   <- build_matriz_pexcc(matriz_mensual)
curvas_pexcc   <- calc_curvas_pexcc(matriz_pexcc, probs_exc)
```



# 1. Descripción de la estación

La estación pluviométrica `r nombre_estacion`, administrada por `r info_estacion$owner`, se localiza en la Región `r info_estacion$nombre_region`, a una latitud de `r round(info_estacion$lat,2)`° y longitud `r  round(info_estacion$lon,2)`°, con una elevación aproximada de `r info_estacion$elev` m s.n.m.. La estación registra la variable precipitación diaria (mm/día) y cuenta con una serie de datos que se extiende desde el `r info_estacion$first_record`  hasta el `r info_estacion$last_record` , totalizando `r as.character(info_estacion$total_days)` días en el período de análisis. De estos,  `r as.character(info_estacion$records_days)` días presentan registros válidos, lo que corresponde a una cobertura del  `r round(info_estacion$records_pctg,2)`%, sin detección de valores atípicos.

#2. Descripción de metricas 

## 1. Curva de Variación Estacional (CVE)

La **Curva de Variación Estacional (CVE)** representa la distribución intra–anual de la **precipitación mensual acumulada** a lo largo del año hidrológico, permitiendo identificar el régimen estacional de las lluvias y los períodos húmedos y secos predominantes.

Sea $RR_{i,j}$ la precipitación mensual acumulada del mes $i$ en el año hidrológico $j$, con $i = 1, \dots, 12$. La precipitación media mensual acumulada se define como:

$$
\overline{RR}_i = \frac{1}{N} \sum_{j=1}^{N} RR_{i,j}
$$

donde $N$ es el número de años hidrológicos con información válida.

La CVE se obtiene graficando $\overline{RR}_i$ en función del mes hidrológico, ordenado desde abril hasta marzo. Esta curva permite:

- Identificar la concentración temporal de la precipitación.
- Reconocer el mes o período de mayor aporte pluviométrico.
- Comparar el comportamiento estacional entre estaciones o cuencas.

---

## 2. Estadísticos Mensuales de la Precipitación (Media, Desviación Estándar y Coeficiente de Variación)

Con el objetivo de caracterizar la variabilidad interanual de la precipitación mensual, se calculan los principales estadísticos descriptivos para cada mes hidrológico.

La **media mensual** se define como:

$$
\overline{RR}_i = \frac{1}{N} \sum_{j=1}^{N} RR_{i,j}
$$

La **desviación estándar mensual**, que cuantifica la dispersión de los valores respecto a la media, se calcula como:

$$
\sigma_i = \sqrt{\frac{1}{N-1} \sum_{j=1}^{N} \left(RR_{i,j} - \overline{RR}_i\right)^2}
$$

Finalmente, el **coeficiente de variación (CV)**, utilizado como una medida adimensional de la variabilidad relativa, se define como:

$$
CV_i = \frac{\sigma_i}{\overline{RR}_i}
$$

Valores elevados de $CV_i$ indican una alta variabilidad interanual de la precipitación mensual, característica común en climas áridos y semiáridos.

---

## 3. Índice de Estacionalidad de la Precipitación (Índice de Markham)

El **Índice de Estacionalidad de Markham (SI)** cuantifica el grado de concentración temporal de la precipitación anual y permite, adicionalmente, identificar el momento del año en que dicha precipitación se concentra. A diferencia de otros índices de estacionalidad, este método representa la precipitación mensual como vectores angulares distribuidos uniformemente a lo largo del ciclo anual.

Sea $P_m$ la precipitación total del mes $m$ en un año hidrológico, con $m = 1, \dots, 12$, y sea $P_{anual}$ la precipitación total anual, definida como:

$$
P_{anual} = \sum_{m=1}^{12} P_m
$$

A cada mes se le asigna un ángulo $\theta_m$ en el círculo anual, definido como:

$$
\theta_m = \frac{2\pi}{12}(m - 1)
$$

La precipitación mensual se representa como un vector de magnitud $P_m$ y dirección $\theta_m$. Las componentes del vector resultante anual se calculan como:

$$
X = \sum_{m=1}^{12} P_m \cos(\theta_m)
$$

$$
Y = \sum_{m=1}^{12} P_m \sin(\theta_m)
$$

El **Índice de Estacionalidad de Markham** se define como la magnitud del vector resultante normalizada por la precipitación anual:

$$
SI = \frac{\sqrt{X^2 + Y^2}}{P_{anual}}
$$

Este índice es adimensional y toma valores comprendidos entre 0 y 1, donde valores cercanos a 0 indican una distribución uniforme de la precipitación a lo largo del año, mientras que valores cercanos a 1 reflejan una fuerte concentración de la precipitación en un período reducido del año.

Adicionalmente, la **fase estacional** o mes dominante de la precipitación se obtiene a partir del ángulo del vector resultante:

$$
\phi = \arctan\left(\frac{Y}{X}\right)
$$

La fase $\phi$ permite identificar el mes o estación del año en la cual se concentra el mayor aporte pluviométrico.

# 3.Resultados
```{r, echo = F}
# =========================================================
# 6. GRÁFICO
# =========================================================
meses_hidro <- c("Abr","May","Jun","Jul","Ago","Sep",
                 "Oct","Nov","Dic","Ene","Feb","Mar")

curvas_long <- curvas_pexcc %>%
  pivot_longer(cols = -Pexc, names_to = "Mes", values_to = "RR") %>%
  mutate(
    Mes = factor(Mes, levels = meses_hidro),
    Pexc_lab = paste0("P", Pexc * 100, "%")
  )

ggplot(curvas_long,
       aes(Mes, RR, color = Pexc_lab, group = Pexc_lab)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  labs(
    title = paste("Curvas mensuales de excedencia –", nombre_estacion),
    x = "Mes hidrológico",
    y = "Precipitación mensual (mm)",
    color = "Prob. excedencia"
  ) +
  theme_minimal()


# =========================================================
# 8. ÍNDICE DE ESTACIONALIDAD DE MARKHAM
# =========================================================
calc_SI_Markham <- function(matriz_mensual) {
  
  meses <- setdiff(names(matriz_mensual), "year_h")
  n_mes <- length(meses)
  
  # Ángulos hidrológicos (Abr = 0, Mar = 330°)
  theta <- 2 * pi / n_mes * (0:(n_mes - 1))
  
  matriz_mensual %>%
    rowwise() %>%
    mutate(
      P_anual = sum(c_across(all_of(meses)), na.rm = TRUE),
      
      X = ifelse(
        P_anual == 0,
        NA_real_,
        sum(c_across(all_of(meses)) * cos(theta), na.rm = TRUE)
      ),
      
      Y = ifelse(
        P_anual == 0,
        NA_real_,
        sum(c_across(all_of(meses)) * sin(theta), na.rm = TRUE)
      ),
      
      SI_Markham = ifelse(
        P_anual == 0,
        NA_real_,
        sqrt(X^2 + Y^2) / P_anual
      ),
      
      Fase_rad = atan2(Y, X),
      
      Fase_mes = ifelse(
        is.na(Fase_rad),
        NA_real_,
        ((Fase_rad %% (2 * pi)) / (2 * pi)) * n_mes + 1
      )
    ) %>%
    ungroup() %>%
    select(year_h, P_anual, SI_Markham, Fase_mes)
}

SI_Markham_df <- calc_SI_Markham(matriz_mensual)

ggplot(SI_Markham_df, aes(x = year_h)) +
  
  # Línea SI Markham
  geom_line(
    aes(y = SI_Markham, color = "SI de Markham"),
    linewidth = 1
  ) +
  
  # Puntos SI Markham
  geom_point(
    aes(y = SI_Markham, color = "SI de Markham"),
    size = 2
  ) +
  
  # Puntos fase (escalada a [0,1])
  geom_point(
    aes(y = Fase_mes / 12, color = "Mes dominante"),
    size = 2
  ) +
  
  scale_color_manual(
    name = "Variable",
    values = c(
      "SI de Markham" = "steelblue",
      "Mes dominante" = "firebrick"
    )
  ) +
  
  scale_y_continuous(
    name = "SI de Markham",
    sec.axis = sec_axis(
      ~ . * 12,
      name = "Mes dominante",
      breaks = 1:12,
      labels = c("Abr","May","Jun","Jul","Ago","Sep",
                 "Oct","Nov","Dic","Ene","Feb","Mar")
    )
  ) +
  
  labs(
    title = "Estacionalidad y fase dominante de la precipitación",
    x = "Año hidrológico"
  ) +
  
  theme_minimal() +
  theme(
    legend.position = "bottom"
  )


# =========================================================
# MÉTRICAS ESTADÍSTICAS MENSUALES (MEDIA, SD, CV)
# =========================================================
calc_stats_mensuales <- function(matriz_mensual) {
  
  meses <- setdiff(names(matriz_mensual), "year_h")
  
  matriz_mensual %>%
    pivot_longer(
      cols = all_of(meses),
      names_to = "Mes",
      values_to = "RR"
    ) %>%
    group_by(Mes) %>%
    summarise(
      Media = mean(RR, na.rm = TRUE),
      SD    = sd(RR, na.rm = TRUE),
      CV    = ifelse(Media == 0 | is.na(Media),
                     NA_real_,
                     SD / Media),
      .groups = "drop"
    ) %>%
    mutate(
      Mes = factor(
        Mes,
        levels = c("Abr","May","Jun","Jul","Ago","Sep",
                   "Oct","Nov","Dic","Ene","Feb","Mar")
      )
    ) %>%
    arrange(Mes)
}

stats_mensuales <- calc_stats_mensuales(matriz_mensual)

ggplot(stats_mensuales,
       aes(x = Mes, y = Media)) +
  geom_col(fill = "steelblue") +
  geom_errorbar(
    aes(ymin = Media - SD, ymax = Media + SD),
    width = 0.2
  ) +
  labs(
    title = "Climatología mensual de precipitación",
    x = "Mes hidrológico",
    y = "Precipitación mensual media (mm)"
  ) +
  theme_minimal()
```

